{{style}}	
	<link rel="stylesheet" type="text/css" href="{#SITE_ROOT#}/css/EpiCollect2.css" />
	<link rel="stylesheet" type="text/css" href="{#SITE_ROOT#}/css/jquery-ui-1.8.17.custom.css" />
	<style type="text/css">
		#uploadxml
		{
			border: 0;
			width: 50em;
			height : 4em;
			overflow: visible;
		}
		
		table
		{ 
			width: 50em;
			margin-bottom: 1em;
		}
		
		th
		{
			text-align : left;
		}
		
		section
		{
			display: inline-block;
			width : 50em;
			height: 50em;
		}
		section p
		{
			text-align: center;
		}
		
		.panelSwitcher 
		{
			float : right;
			margin : 0.5em 0.25em 0.2em 0.25em;
		}
		
		.remove
		{
			width : 6.5em;		
		}
	</style>
{{/style}}

{{script}}
  <!--<script type="text/javascript" src="{#SITE_ROOT#}/js/EpiCollect2.js"></script>-->
  <script type="text/javascript" src="{#SITE_ROOT#}/js/jquery-1.7.1.min.js"></script>
  <script type="text/javascript" src="{#SITE_ROOT#}/js/jquery-ui-1.8.17.custom.min.js"></script>
  <script type="text/javascript">
  	var obj;
  	var publicOpts;
  	var listOpts;
  	var curEmail = "{#userEmail#}";
  	
  	var curators = "{#curators#}".split(",");
  	var managers = "{#managers#}".split(",");
  	var projectName = "{#projectName#}"
  	var isPublic = {#public#};
  	var isListed = {#listed#};
  	
  	$(function(){
  		$(".projectName").text(projectName);
  		
  		publicOpts = $('#public').buttonset();
  		listOpts = $('#listed').buttonset();
  		$('.panelSwitcher, .button').button();
  		
  		for(var i = 0; i < curators.length; i++)
  		{
  			addUser("curators", curators[i]);
  		}
  		
  		for(var i = 0; i < managers.length; i++)
  		{
  			addUser("managers", managers[i]);
  		}
 		
		$('form').tabs();
		
		$('#uploadxml').load(function(){
			if($('#uploadxml')[0].contentDocument.forms[0])
			{
		  		$($('#uploadxml')[0].contentDocument.forms[0].xml).change(function(){
		  			$('#uploadxml')[0].contentDocument.forms[0].submit();
		  		});
			}
			$('#uploadxml').load(function(){
				$('#uploadStatus').empty();
	  			try{obj = JSON.parse($($('#uploadxml')[0].contentDocument.body).text());}catch(err){}
	  			if(!obj || !obj.valid){
	  				
	  				if($('#uploadxml')[0].contentWindow.location.href != location.origin + "{#SITE_ROOT#}/html/projectIFrame.html") {$('#uploadxml')[0].src = "{#SITE_ROOT#}/html/projectIFrame.html";}
	  				$('#uploadxml').show();
	  				//show error messages
	  				$('#uploadStatus').addClass("err");
	  				$('#uploadStatus').removeClass("go");
	  				$('#uploadStatus').append("<p>" + obj.msgs.join("</p><p>") + "</p>");
	  				$('#pdNext').button("disable");
	  			}
	  			else
	  			{
	  				if($('#uploadxml')[0].contentWindow.location.href != location.origin + "{#SITE_ROOT#}/html/projectIFrame.html") {$('#uploadxml')[0].src = "{#SITE_ROOT#}/html/projectIFrame.html";}
	  				$('#uploadStatus').addClass("go");
	  				$('#uploadStatus').removeClass("err");
	  			
	  				$('#uploadStatus').append("XML is valid for the project " + obj.name);
	  				$('.projectName').empty().append(obj.name);
	  				$(document.forms[0].xml).val(obj.file);
	  				$('#pdNext').button("enable");
	  			}
	  		});
		})
  		
  		//goTo('projectDef');
		
		
  	});
  	
  	function goTo(sectionId)
  	{
  		$('section').hide();
  		$('#' + sectionId).show();
  	}
  	
  	function addUser(uType, email)
  	{
  		if(email.match(/^[A-Z0-9\._%+-]+@[A-Z0-9\.-]+\.[A-Z]{2,4}$/i))
  		{
  			var rm = "";
  			
  			if(!$("#" + uType).val().match(new RegExp(email, "i")))
  			{
  				if(email != curEmail) rm = "<a class=\"remove\" href=\"javascript:removeUser('" + uType + "','" + email + "')\">Remove</a>";
  				$("#s_" + uType + " tbody").append("<tr><td>" + email + "</td><td>"  + rm + "</td></tr>");
  			}
  			updateUField(uType);
  			
  		}
  		else
  		{
  			$('#message').empty().append("<p class=\"flash err\">" + uType + " must be added using their email address, <em>" + email+ "</em> is not an email address</p>");
  		}
  	}
  	
  	function removeUser(uType, email)
  	{
  		$("#s_" + uType + " tr").each(function(idx, ele)
  		{
  			if($(ele.getElementsByTagName('td')[0]).text() == email)
  			{
  				$(ele).remove()
  			}
  		});
  		updateUField(uType);
  	}
  	
  	function updateUField(uType)
  	{
  		$("#" + uType).val("");
  		$("#s_" + uType + " tr").each(function(idx, ele){
  			$("#" + uType).val($("#" + uType).val() + (idx > 1 ? "," : "") + $(ele.getElementsByTagName('td')[0]).text());
  		});
  	}
  	
  	function showMessage(msg, type)
  	{
  		$('#message').empty().append("<p class=\"flash " + type + "\">" + msg + "</p>");
  	}
  	
  	function save()
  	{
  		$.ajax({
  			url : location.href + 'Structure',
  			type : 'POST',
  			data : $('form').serialize(),
  			success: function(data, status, xhr){
  				showMessage("Project updates saved", "go");  				
  			},
  			error : function(xhr, status, err){
  				showMessage("Project update failed", "err");		  				
  			}
  		});
  	}
  	
  </script>
{{/script}}
{{breadcrumbs}}
  &gt; <a href="createProject.html">{#title#}</a>
{{/breadcrumbs}}
{{main}}
	  <h1 id="title">Create a Project - <span class="projectName"></span></h1>
	  <div id="message"></div>
	  <form id="projectOptions" action="updateStructure" method="POST">
	  		<ul>
	  			<li><a href="#projectDef">Project Definition</a></li>
	  			<li><a href="#visibility">Visibility</a></li>
	  			<li><a href="#listing">Listing</a></li>
	  			<li><a href="#s_managers">Managers</a></li>
	  			<li><a href="#s_curators">Curators</a></li>
	  		</ul>
		  	<section id="projectDef">
			  	<h2>1. Project Definition</h2>
			  	<iframe id="uploadxml" src="{#SITE_ROOT#}/html/projectIFrame.html"></iframe>
		  		<div id="uploadStatus" class="flash"></div>
		 		<input type="hidden" name="xml"/>
		 		<a class="panelSwitcher" href="javascript:save()">Save Changes</a>
		 		
	 		</section>
		 	<section id="visibility">
				<h2>2. Visibility</h2>
				<p>EpiCollect+ allows project data to either be public of private, please choose one of the following options</p>
				<div id="public">
					<input type="radio" name="public" id="isPublic" value="true" checked="checked"/><label for="isPublic">I would like anyone to be able <br />to view the data in this project.</label>
					<input type="radio" name="public" id="isPrivate" value="false" /><label for="isPrivate">I only want people I specify to be able<br /> to view the data in this project.</label>
				</div>
				<a class="panelSwitcher" href="javascript:save()">Save Changes</a>
				
			</section>
			<section id="listing">
				<h2>3. Listing on the Homepage</h2>
				<p>The front page of this server displays a list of projects that have been created on this server, please choose one of the following options</p>
				<div id="listed">
					<input type="radio" name="listed" id="isListed" value="true" checked="checked" /><label for="isListed">I would like this project to appear <br />on the list on the homepage of this server.</label>
					<input type="radio" name="listed" id="notListed" value="false" /><label for="notListed">I would not like this project to appear <br />on the list on the homepage of this server.</label>
				</div>
				<a class="panelSwitcher" href="javascript:save()">Save Changes</a>
			</section>
			<section id="s_managers">
				<h2>4. Project Managers</h2>
				<p>Any users in this group have the ability to add and remove other project managers and curators, they can also update the project 
				settings and the project definition. Managers can also Add, edit and remove data using the web interface.</p>
				<table> 
					<thead>
						<tr><th>Email</th><th class="remove">Remove</th></tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<label for="newmanager">Enter the email address for the manager you wish to add </label><input type="email" id="newmanager" /><a class="button" href="javascript:addUser('managers', $('#newmanager').val())">Add manager</a>
				<input type="hidden" name="managers" id="managers"/>
				<a class="panelSwitcher" href="javascript:save()">Save Changes</a>
			</section>
			<section id="s_curators">
				<h2>5. Project Curators</h2>
				<p>Any users in this group are allowed to use the web interface to add, edit and remove data. Anyone can upload data from the EpiCollect+ Android App. If this project is not public then 
				only Curators and managers will be able to use the web interface for this project.</p>
				<table> 
					<thead>
						<tr><th>Email</th><th class="remove">Remove</th></tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<label for="newcurator">Enter the email address for the curator you wish to add </label><input type="email" id="newcurator" /><a class="button" href="javascript:addUser('curators', $('#newcurator').val())">Add curator</a>
				<input type="hidden" name="curators" id="curators"/>
				<a class="panelSwitcher" href="javascript:save()">Save Changes</a>
			</section>
			
	</form>
  
{{/main}}