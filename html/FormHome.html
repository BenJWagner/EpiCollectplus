{{style}}
	<link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.css" />
	<!--[if lte IE 8]>
	    <link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.ie.css" />
	<![endif]-->
	<style type="text/css">
		img.desc
		{
			display : none;
			float : right;
			margin-top: 0.25em;
		}
		
		.desc img.desc
		{
			display : inline-block;
		}
		
		img.asc
		{
			display : none;
			float : right;
			margin-top: 0.25em;
		}
		
		.asc img.asc
		{
			display : inline-block;
		}
	
		.cp-item {
			vertical-align: top;
			display: inline-block;
			margin-left : 10px;
		}
		
		.cp-item img {
			margin: 0;
		}
		
		.entry
		{
			border-bottom : 1px solid #CCCCCC;
			background-color : #EEEEEE;
			margin : 0;
			padding : 5px 5px 5px 5px;
			
		}
		
		.nolocation
		{
			font-style : italic; 
		}
		
		#timeText
		{
			width : 30em;
		}
		
		.button
		{
			padding : 0.25em 0.5em 0.25em 0.5em;
			margin : 0em 0.25em 0em 0.25em;
			background-color:#C7DFFC;
			border-radius: 0.25em;
			cursor: pointer;
			font-weight : bold;	
			width : 30%;
		}
		
		#mapTab
		{
			position : relative;
		}
		
		#map
		{
			position : relative;
			margin-left : 15em;
			height : 30em;
			margin-right : 15em;
		}
		
		#bottombar
		{
			margin : 1em -1.5em 1em -1.5em;
			position : relative;
			height : 10em;
			padding: .5em .5em .5em .5em;
		}
		
		#bottombar div.filterControl, #bottombar div.colourControl
		{
			height: 100%;
			width: 20em;
			display : inline-block;
			border : 1px solid #CCCCCC;
			padding: 0.5em;
			position : relative;
			vertical-align : top;
		}
				
		#bottombar div.filterControl.active
		{
			display : inline-block;
			border : 1px solid #CCCCFF;
		}
		
		#sidebar 
		{
			border: 1px solid #CCCCCC;
			bottom : 13.25em;
			overflow : auto;
			left : 0;
			position : absolute;
			top : 1em;
			width : 15em;
		}
		
		#sidebar a 
		{
			display : block;
		}
		
		
		#slider-range
		{
			margin: 0.5em 0.5em 0.5em 0.5em;
			border: 1px solid #CCCCFF !important;
			width : 15em;
		}

		
		.filterControl b 
		{
			display : inline-block;
			width: 6em;
		}
		
		#graphbar 
		{
			border: 1px solid #CCCCCC;
			bottom : 13.25em;
			right : 0;
			overflow : auto;
			position : absolute;
			top : 1em;
			width : 15em;
		}
		
		.button:active
		{
			background-color: #CCCCCC;
		}
		
		.clearFilter
		{
			display : none;
		}
		
		.active .clearFilter
		{
			display:inline-block;
			position:absolute;
			bottom:0;
			right: 0;
		}
		
	</style>
{{/style}}

{{script}}
	{#mapScript#}
	<!-- <script src="http://code.leafletjs.com/leaflet-0.3.1/leaflet.js"></script>-->
	<!-- <script src="http://maps.google.com/maps/api/js?sensor=false" ></script>-->
	<!-- <script type="text/javascript" src="{#formName#}.js"></script>-->
	<script type="text/javascript" src="{#SITE_ROOT#}/js/jquery-ui-1.8.17.custom.min.js"></script>
	<script type="text/javascript" src="{#SITE_ROOT#}/js/gpsPicker.js"></script>
	<script type="text/javascript" src="{#SITE_ROOT#}/js/jquery.controlgroup.js"></script>
	<script type="text/javascript">
			var formName = "";
			var map = null;
			
			var mapData = null;
			var markers = [];			
			
			var qry = location.search.trim("?");
			var sortCol = "created";
			var sortDir = "asc";
			var pageNo = 0;
			var numEnts = 10;
			
			var filterField = "";
			var filterValue = "";
			
			var nextFormName = "";
			
			var markerClusterer = null;
			
			var bubble = null;
			
			var geoField = null;
			
			var dateFormat = " dd MM yyyy hh:mm:ss";
			
			var colours = [
				"rgba(255,0,0,1)",
				"rgba(0,128,0,1)",
				"rgba(192,192,192,1)",
				"rgba(255,255,0,1)",
				"rgba(255,255,255,1)",
				"rgba(128,0,128,1)",
				"rgba(128,128,128,1)",
				"rgba(128,0,0,1)",
				"rgba(0,0,204,1)", 
				"rgba(159,255,159,1)",
				"rgba(255,157,206,1)",
				"rgba(179,102,255,1)",
				"rgba(120,68,33,1)"
			];
			
			$(function()
			{
				url = location.href.trim("/");
				if(url.indexOf("?") > 0)url = url.substr(0, url.indexOf("?"));
				formName = url.substr(url.lastIndexOf("/") + 1).replace(/#.*$/, "");
				url = url.substr(0, url.lastIndexOf("/"));
				
				
				EpiCollect.loadProject(url + ".xml", loadCallback);
				
				$.fn.disableSelection = function() {
				    return this.each(function() {           
				        $(this).attr('unselectable', 'on')
				               .css({
				                   '-moz-user-select':'none',
				                   '-webkit-user-select':'none',
				                   'user-select':'none',
				                   '-ms-user-select':'none'
				               })
				               .each(function() {
				                   this.onselectstart = function() { return false; };
				               });
				    });
				};
				
				
			});
	
			
			function createMap(div)
			{
				map = new google.maps.Map(document.getElementById(div), {
					center : new google.maps.LatLng(0,0),
					mapTypeId: google.maps.MapTypeId.HYBRID,
					zoom : 2,
					panControl: true,
					rotateControl: true,
					zoomControl: true
				});
			}
			
			function loadCallback(prj){
				project = prj;		
				
				
				hasMap = (project.forms[formName].gpsFlds.length > 0);
				if(hasMap) geoField = project.forms[formName].gpsFlds[0]
				
				for(nextForm = project.getNextForm(formName); nextForm; nextForm = project.getNextForm(nextForm.name))
				{
					if(nextForm.main)
					{
						nextFormName = nextForm.name;
						break;
					}
				}
				
				$("#tabs").tabs({
					show : function(event, tab)
					{
						if(tab.panel.id == "mapTab")
						{
							 cen = map.getCenter();
							 google.maps.event.trigger(map, 'resize');
							 map.setCenter(cen);
							 getMapData();
						}
					}
				});
				
				if(hasMap)
				{
					createMap("map");			
				}
				else
				{
					$("#tabs li")[1].style.display = "none"; 
				}
				
				
				$("#tableTab .ecplus-toolbar").after("<table class=\"ecplus-data\"><thead><tr></tr></thead><tbody></tbody></table>");
				
				for(f in project.forms[formName].fields)
				{
					fld = project.forms[formName].fields[f];
					$(".ecplus-data tr").append("<th class=\"" + f + "\">" + fld.text + "</th>");	
					
					
				}
				if(nextFormName) $(".ecplus-data tr").append("<th class=\"" + f + "\">" + nextFormName + " Entries</th>");
				$(".ecplus-data th").resizable({
					handles : "e",
					resize	: function(event, ele)
					{
						window.e = event;
						window.ele = ele;
					
		
						
						$("td." + ele.element[0].className.substring(0, ele.element[0].className.indexOf(" "))).css({ "max-width" : (ele.element.width()-5) + "px"});
					}
				});
				
				$(".ecplus-data th").append("<img src=\"../images/uparrow.png\" class=\"asc\" width=\"12\" /><img src=\"../images/downarrow.png\" class=\"desc\" width=\"12\" />")
				$(".ecplus-data th").click(function(evt){
					
						var newSortCol = evt.target.classList[0];
						
						
						$(".ecplus-data th").removeClass("desc");
						$(".ecplus-data th").removeClass("asc");
			
						console.debug(sortCol + " " + sortDir);
						window.evt = evt;
						if(newSortCol == sortCol && sortDir == "asc")
						{
							$(evt.target).addClass("desc");
							sortDir = "desc";
						}
						else
						{
							$(evt.target).addClass("asc");
							sortDir = "asc";
						}
						sortCol = newSortCol;
						getData();
						evt.preventDefault();
					
				});
				
				getData();
				
				for(fld in project.forms[formName].fields)
				{
					if(project.forms[formName].fields[fld].type != "location" && project.forms[formName].fields[fld].type != "gps" && project.forms[formName].fields[fld].type != "branch"
							&& project.forms[formName].fields[fld].type != "video" && project.forms[formName].fields[fld].type != "audio" && project.forms[formName].fields[fld].type != "photo")
					{
						$('.fieldList').append("<option value=\"" + fld + "\">" + project.forms[formName].fields[fld].text +  "</option>")
						if(project.forms[formName].fields[fld].type == "select" || project.forms[formName].fields[fld].type == "radio" ||project.forms[formName].fields[fld].type == "select1" 
								|| fld == project.getPrevForm(formName).key || fld == "DeviceID")
						{
							$('.colourFieldList').append("<option value=\"" + fld + "\">" + project.forms[formName].fields[fld].text +  "</option>");
						}
					}
				}
				
				$('#filter_value').autocomplete(
				{
					source : baseUrl+ "/" + $('#filter_fields').val()
				});
				
				$('#mapFilterValue').autocomplete(
				{
					source : baseUrl+ "/" + $('#mapFilterField').val()
				});
				
				$('#filter_fields').change(function(){
					$('#filter_value').autocomplete("option", "source" , baseUrl+ "/" + $('#filter_fields').val());
				});
				
				$('#mapFilterField').change(function(){
					$('#mapFilterValue').val("");
					$('#mapFilterValue').autocomplete("option", "source" , baseUrl+ "/" + $('#mapFilterField').val());
				});
				
				$('#filter_value').blur(function(){doFilter($('#filter_fields').val(), $('#filter_value').val())})
				var t = new Date().getTime()
				$( "#slider-range" ).slider({
					range: true,
					min : 0,
					max : t,
					values: [0,  t],
					slide : function (event, ui)
					{
						filterMap(function(data){ return data["created"] >= ui.values[0] && data["created"] <= ui.values[1]; })
						$("#timeFrom").text(new Date(ui.values[0]).format(dateFormat));
						$("#timeTo").text(new Date(ui.values[1]).format(dateFormat));
						
						$(".filterControl").removeClass("active");
						$("#timeFilter").addClass("active");
					}
				});
			};	
			
			
			function getData()
			{
				offset = pageNo * numEnts
				var urlStr = url + "/" + formName + ".json?mode=list&offset=" + offset + "&limit=" + numEnts + "&sort=" + sortCol + "&dir=" +sortDir + "&" + location.search.substr(1);
				var statUrl = url + "/" + formName + "/__stats?" + location.search.substr(1);;
				
				if(filterField && filterValue)
				{
					urlStr += "&" + filterField + "=" + filterValue;
					statUrl += "&" + filterField + "=" + filterValue; 
				}
				$.getJSON(urlStr , dataLoad);
				$.getJSON(statUrl , statLoad);
				$('#start').text(offset);
			}
			
			function getMapData()
			{
				var urlStr = url + "/" + formName + ".json?mode=list&sort=" +  project.forms[formName].titleField;
				if(filterField && filterValue)
				{
					urlStr += "&" + filterField + "=" + filterValue;
					statUrl += "&" + filterField + "=" + filterValue; 
				}
				$.getJSON(urlStr , mapDataCallback);
			}
			
			function doFilter(field, value)
			{
				filterField = field;
				filterValue = value;
				pageNo = 0;
				getData();
			}
			
			function dataLoad(entries)
			{
				window.ecplus_entries = entries;
				
				$(".ecplus-data tbody").empty();
				
				$('#end').text(Number($('#start').text()) + Number(entries.length));
				$('#total').text(entries.count);
				
				for(var i = 0; i < entries.length; i++)
				{
					html = "<tr class=\"" + (i % 2 == 1 ? " alt": "") + "\">";
					for(f in project.forms[formName].fields)
					{	
						fld = project.forms[formName].fields[f];
						html += "<td class=\"" + f   + "\">";
						if(fld.type == "location" || fld.type == "gps")
						{
							if(entries[i][f] == undefined)
							{
								html += "&nbsp;";
							}
							else
							{
								val = entries[i][f];
								html +=  val.latitude + "," + val.longitude;
							}
						
						}
						else
						{
							html += entries[i][f] == undefined ? "&nbsp;" : entries[i][f];
						}
						html += "</td>"					
					}
					if(nextFormName) html += "<td>" + entries[i][nextFormName + "_entries"]  + "</td>";
					html += "</tr>";
					$(".ecplus-data tbody").append(html);
				}
				
				for(f in project.forms[formName].fields)
				{
					$('.' + f).css({"max-width" : $('th.' + f).width() + "px"});
				}
				
				$(".ecplus-data tr").click(function(evt)
				{
					$(".ecplus-data tr").removeClass("selected");
					$(evt.target.parentNode).addClass("selected");
				});
			}
			
			function statLoad(stats)
			{
				$("#total").text(stats["ttl"]);
			}
			
			function mapDataCallback(data, status, xhr)
			{
				delete mapData;
				mapData = data;
				delete markers;
				markers = [];
				
				var mincreated = new Date().getTime();
				var maxcreated = 0;
				
				var keyField = project.forms[formName].key;
				
				for(var i = 0; i < data.length; i++)
				{
					var mkr = new google.maps.Marker({
						id : data[i][keyField],
						position : new google.maps.LatLng(data[i][geoField].latitude, data[i][geoField].longitude),
						icon : "{#SITE_ROOT#}/markers/point",
						index : i
					});
					
					mincreated = Math.min(mincreated, Number(data[i]["created"]));
					maxcreated = Math.max(maxcreated, Number(data[i]["created"]));
				
					google.maps.event.addListener(mkr, 'click', function(evt, x){
						showBubbleFor(getMarkerAt(evt.latLng).index);
					});
					
					markers.push(mkr);
					addToSidebar(i, data[i][project.forms[formName].titleField])
				}
				
				colourMarkersBy("DeviceID");
				
				markerClusterer = new MarkerClusterer(map, markers,
				{
					maxZoom : 12,
					gridSize : 60,
					styles : [
						{
							url : "{#SITE_ROOT#}/markers/cluster",
							height: 50,
					        width: 50,
					        anchor: [24, 24],
					        textColor: 'transparent',
					        textSize: 14
						},
						{
							url : "{#SITE_ROOT#}/markers/cluster",
							height: 50,
					        width: 50,
					        anchor: [24, 24],
					        textColor: 'transparent',
					        textSize: 14
						},
						{
							url : "{#SITE_ROOT#}/markers/cluster",
							height: 50,
					        width: 50,
					        anchor: [24, 24],
					        textColor: 'transparent',
					        textSize: 14
						},
						{
							url : "{#SITE_ROOT#}/markers/cluster",
							height: 50,
					        width: 50,
					        anchor: [24, 24],
					        textColor: 'transparent',
					        textSize: 14
						}
					]
				});

				
				$("#slider-range").slider("option", "min", mincreated);
				$("#slider-range").slider("option", "max", maxcreated);
				
				$("#timeFrom").text(new Date(mincreated).format(dateFormat));
				$("#timeTo").text(new Date(maxcreated).format(dateFormat));
				
			}			
			
			function showBubbleFor(mkrIdx)
			{
				if(bubble) closeBubble();
				
				bubble = new google.maps.InfoWindow({
					content : getContentFor(mkrIdx),
					position : getPositionFor(mkrIdx)
				});
				
				bubble.open(map);
			}
			
			function getMarkerAt(latlng)
			{
				for(mkr in markers)
				{
					if(markers[mkr].getPosition() == latlng) return markers[mkr];
				}
			}
			
			function addToSidebar(index, text)
			{
				$("#sidebar").append("<a href=\"javascript:showBubbleFor(" + index + ")\" index=\"" + index +"\">" + text +  "</a>");
			}
			
			function closeBubble()
			{
				bubble.close();
			}
			
			function getPositionFor(mkrIdx)
			{
				return new google.maps.LatLng(mapData[mkrIdx][geoField].latitude, mapData[mkrIdx][geoField].longitude);
			}
			
			function getContentFor(mkrIdx)
			{
				var rec = mapData[mkrIdx];
				var html = "";
				
				for(fld in project.forms[formName].fields)
				{
					html += "<b>" + fld + "</b> : " + project.forms[formName].fields[fld].formatValue(rec[fld]) + "<br />";
				}
				return html;
			}
			
			function filterMap(filterFunction)
			{
				markerClusterer.setIgnoreHidden(true);
				for(var i = 0; i < mapData.length; i++)
				{
					var vis = filterFunction(mapData[i]);
					markers[i].setVisible(vis);
					
				}
				markerClusterer.repaint();
			}
			
			function clearMapFilter()
			{
				for(var i = 0; i < markers.length; i++)
				{
					markers[i].setVisible(true);
				}
				markerClusterer.repaint();
				
				$(".filterControl").removeClass("active");
				$("#slider-range").slider("values", 0, $("#slider-range").slider("option", "min"));
				$("#slider-range").slider("values", 1, $("#slider-range").slider("option", "max"));
				
			}
			
			function doMapFieldFilter()
			{
				filterMap(function(data){
					var field = $("#mapFilterField").val();
					var val = $("#mapFilterValue").val();
					
					return data[field] == val;
				});
				
				$(".filterControl").removeClass("active");
				$("#fieldFilter").addClass("active");
			}
			
			function colourMarkersBy(fld)
			{
				var colourGrps = {};
				var colourIdx = 0;
				
				for(var i = 0; i < mapData.length; i++)
				{
					if(!colourGrps[mapData[i][fld]])
					{
						colourGrps[mapData[i][fld]] = colours[colourIdx++ % colours.length];
					}
					markers[i].setIcon("{#SITE_ROOT#}/markers/point?colour=" + colourGrps[mapData[i][fld]])
					markers[i].colour = colourGrps[mapData[i][fld]];
				}
				
				if(markerClusterer) markerClusterer.repaint();
			}
			
	</script>
	
{{/script}}
{{breadcrumbs}}
&gt; <a href="../{#projectName#}">Project : {#projectName#}</a> {#prevForm#} &gt; Form : {#formName#}
{{/breadcrumbs}}
{{main}}
	<h1>{#projectName#} - {#formName#}</h1>
	<div id="tabs">
		<ul>
			<li><a href="#tableTab">Table View</a>
			<li><a href="#mapTab">Map</a>
		</ul>
		<div id="tableTab">
			<p class="ecplus-toolbar">
				<a href="javascript:project.forms[formName].displayForm();"><img src="{#SITE_ROOT#}/images/glyphicons/glyphicons_248_asterisk.png" title="New Entry" alt="New Entry"></a>
				<a href="javascript:project.forms[formName].displayForm(undefined, window.ecplus_entries[$('.ecplus-data tbody tr.selected').index()]);"><img src="{#SITE_ROOT#}/images/glyphicons/glyphicons_030_pencil.png" title="Edit Entry" alt="Edit Entry"></a>
				<a href="javascript:project.forms[formName].deleteEntry(window.ecplus_entries[$('.ecplus-data tbody tr.selected').index()][project.forms[formName].key]);"><img src="{#SITE_ROOT#}/images/glyphicons/glyphicons_016_bin.png" title="Delete Entry" alt="Delete Entry"></a>
				<span class="ecplus-toobar-divider">&nbsp;</span> 
				Filter List By <select id="filter_fields" class="fieldList"></select> <input id="filter_value" /> <a href="javascript:doFilter($('#filter_fields').val(), $('#filter_value).val());"><img src="{#SITE_ROOT#}/images/glyphicons/glyphicons_027_search.png" title="Filter" alt="Filter"></a>
				<a href="javascript:doFilter('','');"><!--  <img src="{#SITE_ROOT#}/images/glyphicons/glyphicons_027_search.png" title="Clear Filter" alt="Clear Filter">-->Clear Filter</a>
				<span class="ecplus-toobar-divider">&nbsp;</span> 
				<a href="./{#formName#}.csv"><img src="{#SITE_ROOT#}/images/glyphicons/glyphicons_200_download.png" title="Dowload Data as CSV" alt="Download CSV"></a>
				<a href="./{#formName#}.tsv"><img src="{#SITE_ROOT#}/images/glyphicons/glyphicons_200_download.png" title="Dowload Data as TSV" alt="Download TSV"></a>
				<a href="./{#formName#}.xml" target="__blank"><img src="{#SITE_ROOT#}/images/glyphicons/glyphicons_200_download.png" title="Dowload Data as XML" alt="Download XML"></a>
			</p>
			
			<p>Showing <span id="start"></span> to <span id="end"></span> of <span id="total"></span></p>	
		</div>
		<div id="mapTab">
			<div id="sidebar">
				
			</div>
			<div id="map"></div>
			<div id="graphbar"></div>
			<div id="bottombar">
				<div id="timeFilter" class ="filterControl">
					<h4>Filter By Time</h4>
					<div id="slider-range" ></div>
					<p><b>From :</b><span id="timeFrom"></span></p>
					<p><b>To :</b><span id="timeTo"></span></p>
					<span class="clearFilter"><a href="javascript:clearMapFilter();">Clear Filter</a></span>
				</div>
				<div id="fieldFilter" class ="filterControl">
					<h4>Filter By Field</h4>
					<p><b>Field </b><select id="mapFilterField" class="fieldList"></select></p>
					<p><b>Value </b><input id="mapFilterValue"></input></p>
					<p><a href="javascript:doMapFieldFilter()">Apply Filter</a></p>
					<span class="clearFilter"><a href="javascript:clearMapFilter();">Clear Filter</a></span>
				</div>
				<div id="fieldColour" class ="colourControl">
					<h4>Colour By Field</h4>
					<p><b>Field </b><select id="mapColourField" class="colourFieldList"></select></p>
					<p><a href="javascript:colourMarkersBy($('#mapColourField').val())">Apply Colouring</a></p>
				</div>
			</div>
		</div>
		
	</div>
{{/main}}