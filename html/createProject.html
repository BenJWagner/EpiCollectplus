{{style}}	
	<style type="text/css">
		#uploadxml
		{
			border: 0;
			width: 50em;
			height : 4em;
			overflow: visible;
		}
		
		table
		{ 
			width: 50em;
			margin-bottom: 1em;
		}
		
		th
		{
			text-align : left;
		}
		
		.section
		{
			display: inline-block;
			width : 50em;
			height: 50em;
		}
		
		.panelSwitcher 
		{
			float : right;
			margin : 0.5em 0.25em 0.2em 0.25em;
		}
		
		.remove
		{
			width : 6.5em;		
		}
	</style>
{{/style}}

{{script}}
  <script type="text/javascript">
  	var obj;
  	var publicOpts;
  	var listOpts;
  	var curEmail = "{#userEmail#}";
  	
  	$(function(){
  		publicOpts = $('#public').buttonset();
  		listOpts = $('#listed').buttonset();
  		$('.panelSwitcher, .button').button();
		$('#pdNext').button("disable");
		
		$('#s_managers tbody').append("<tr><td>" + curEmail + "</td></tr>");
		$('#managers').val(curEmail);
 		
		$('input[name=name]').change(function(evt){
			$.ajax({
				url: './' + $(evt.target).val(),
				error: function(xhr, status, s){
					$('#pdNext').button("enable");
					$(evt.target).removeClass('ecplus-invalid');
					$('#projectNameMsg').html('<p class="msg">Project name available.</p>');
				},
				success: function(){
					$('#pdNext').button("disable");
					
					$(evt.target).addClass('ecplus-invalid');
					$('#projectNameMsg').html('<p class="err">Project name is already in use. Project name must be unique.</p>');
				}
			});
		});
		
		$('#uploadxml').on('load', function(){
			if($('#uploadxml')[0].contentDocument.forms[0])
			{
		  		$($('#uploadxml')[0].contentDocument.forms[0].xml).change(function(){
		  			$('#uploadxml')[0].contentDocument.forms[0].submit();
		  		});
			}
			$('#uploadxml').on('load', function(){
				
				if($('#uploadxml')[0].contentWindow.location.href == location.protocol + '//' + location.host + "{#SITE_ROOT#}/html/projectIFrame.html") return;
					
				$('#uploadStatus').empty();
	  			try{
	  				obj = JSON.parse($($('#uploadxml')[0].contentDocument.body).text());
	  			}catch(err){
	  				obj = false;
	  			}
	  			
	  			if(!obj || !obj.valid){
	  				
	  				if($('#uploadxml')[0].contentWindow.location.href != location.protocol + '//' + location.host + "{#SITE_ROOT#}/html/projectIFrame.html") {$('#uploadxml')[0].src = "{#SITE_ROOT#}/html/projectIFrame.html";}
	  				$('#uploadxml').show();
	  				//show error messages
	  				$('#uploadStatus').addClass("err");
	  				$('#uploadStatus').removeClass("go");
	  				$('#uploadStatus').append("<p>" + obj.msgs.join("</p><p>") + "</p>");
	  				if(!$('input[name=name]').val()) $('#pdNext').button("disable");
	  			}
	  			else
	  			{
	  				if($('#uploadxml')[0].contentWindow.location.href != location.protocol + '//' + location.host + "{#SITE_ROOT#}/html/projectIFrame.html") {$('#uploadxml')[0].src = "{#SITE_ROOT#}/html/projectIFrame.html";}
	  				$('#uploadStatus').addClass("go");
	  				$('#uploadStatus').removeClass("err");
	  			
	  				$('#uploadStatus').append("XML is valid for the project " + obj.name);
	  				$('.projectName').empty().append(obj.name);
	  				$(document.forms[0].xml).val(obj.file);
	  				$('#pdNext').button("enable");
	  			}
	  			
	  		});
		})
  		
  		goTo('projectDef');
		
		$('#pdNext').mouseover(function(evt){
			$('input[name=name]').change();
		});
		
		$('#uploadBox').accordion({
			autoHeight : false,
			collapsible : true,
			active: false
		});
  	});
  	
  	function goTo(sectionId)
  	{
  		$('.section').hide();
  		$('#' + sectionId).show();
  	}
  	
  	function addUser(uType, email)
  	{
  		if(email.match(/^[A-Z0-9\._%+-]+@[A-Z0-9\.-]+\.[A-Z]{2,4}$/i))
  		{
  			if(!$("#" + uType).val().match(new RegExp(email, "i")))
  			{
  				$("#s_" + uType + " tbody").append("<tr><td>" + email + "</td><td><a class=\"remove\" href=\"javascript:removeUser('" + uType + "','" + email + "')\">Remove</a></td></tr>");
  			}
  			updateUField(uType);
  		}
  		else
  		{
  			$('#message').empty().append("<p class=\"flash err\">" + uType + " must be added using their email address, <em>" + email+ "</em> is not an email address</p>")	
  		}
  	}
  	
  	function removeUser(uType, email)
  	{
  		$("#s_" + uType + " tr").each(function(idx, ele)
  		{
  			if($(ele.getElementsByTagName('td')[0]).text() == email)
  			{
  				$(ele).remove()
  			}
  		});
  		updateUField(uType);
  	}
  	
  	function updateUField(uType)
  	{
  		$("#" + uType).val("");
  		$("#s_" + uType + " tr").each(function(idx, ele){
  			$("#" + uType).val($("#" + uType).val() + (idx > 1 ? "," : "") + $(ele.getElementsByTagName('td')[0]).text());
  		});
  	}
  	
  </script>
{{/script}}
{{breadcrumbs}}
  &gt; <a href="createProject.html">Create Project</a>
{{/breadcrumbs}}
{{main}}
	  <h1 id="title">Create a Project - <span class="projectName"></span></h1>
	  <div id="message" class="flashes"></div>
	  <form id="projectOptions" action="create" method="POST">
		  	<div id="projectDef" class="section">
			  	<h2>1. Project Definition</h2>
			  	<p>Choose a name for the project</p>
			  	<input name="name" />
			  	<div id="projectNameMsg"></div>
			  	<p>Or</p>
			  	<div id="uploadBox">
			  		<h3><a href="#">Upload an existing EpiCollect project definition</a></h3>
			  		<div>
			  			<iframe id="uploadxml" src="{#SITE_ROOT#}/html/projectIFrame.html"></iframe>
		  				<div id="uploadStatus" class="flash"></div>
		 				<input type="hidden" name="xml"/>
		 			</div>
		 			<br/>
		 		</div>
		 		<a class="panelSwitcher" id="pdNext" href="javascript:goTo('visibility');"> Continue </a>
	 		</div>
		 	<div id="visibility" class="section">
				<h2>2. Visibility</h2>
				<p>EpiCollect+ allows project data to either be public of private, please choose one of the following options</p>
				<div id="public">
					<input type="radio" name="public" id="isPublic" value="true" checked="checked"/><label for="isPublic">I would like anyone to be able <br />to view the data in this project.</label>
					<input type="radio" name="public" id="isPrivate" value="false" /><label for="isPrivate">I only want people I specify to be able<br /> to view the data in this project.</label>
				</div>
				<br/>
				<a class="panelSwitcher" href="javascript:goTo('listing');"> Continue </a>	
				<a class="panelSwitcher" href="javascript:goTo('projectDef');"> Back </a>
				
			</div>
			<div id="listing" class="section">
				<h2>3. Listing on the Homepage</h2>
				<p>The front page of this server displays a list of projects that have been created on this server, please choose one of the following options</p>
				<div id="listed">
					<input type="radio" name="listed" id="isListed" value="true" checked="checked" /><label for="isListed">I would like this project to appear <br />on the list on the homepage of this server.</label>
					<input type="radio" name="listed" id="notListed" value="false" /><label for="notListed">I would not like this project to appear <br />on the list on the homepage of this server.</label>
				</div>
				<br/>
				<a class="panelSwitcher" href="javascript:document.forms[0].submit();"> Create Project </a>	
				<!-- <a class="panelSwitcher" href="javascript:goTo('s_managers');"> Continue </a> -->	
				<a class="panelSwitcher" href="javascript:goTo('visibility');"> Back </a>
			</div>
			<div id="s_managers"  class="section">
				<h2>4. Project Managers</h2>
				<p>Any users in this group have the ability to add and remove other project managers and curators, they can also update the project 
				settings and the project definition. Managers can also Add, edit and remove data using the web interface.</p>
				<table> 
					<thead>
						<tr><th>Email</th><th class="remove">Remove</th></tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<label for="newmanager">Enter the email address for the manager you wish to add </label><input type="email" id="newmanager" /><a class="button" href="javascript:addUser('managers', $('#newmanager').val())">Add manager</a>
				<input type="hidden" name="managers" id="managers"/>
				<br/>
				<a class="panelSwitcher" href="javascript:goTo('s_curators');"> Continue </a>	
				<a class="panelSwitcher" href="javascript:goTo('listing');"> Back </a>
			</div>
			<div id="s_curators" class="section">
				<h2>5. Project Curators</h2>
				<p>Any users in this group are allowed to use the web interface to add, edit and remove data. Anyone can upload data from the EpiCollect+ Android App. If this project is not public then 
				only Curators and managers will be able to use the web interface for this project.</p>
				<table> 
					<thead>
						<tr><th>Email</th><th class="remove">Remove</th></tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<label for="newcurator">Enter the email address for the curator you wish to add </label><input type="email" id="newcurator" /><a class="button" href="javascript:addUser('curators', $('#newcurator').val())">Add curator</a>
				<input type="hidden" name="curators" id="curators"/>
				<br/>
				<a class="panelSwitcher" href="javascript:document.forms[0].submit();"> Create Project </a>	
				<a class="panelSwitcher" href="javascript:goTo('s_managers');"> Back </a>
			</div>
	</form>
  
{{/main}}